---
layout: post
title: "Adding CodeBuild reports to Cypress e2e tests using CDK"
date: 2020-09-09
tags: aws codebuild reports testing devops
author: Natalie Laing
image: /img/reports.png
---

![Generic reports](/img/reports.png)

## Introduction

I was recently working on a project where the project owner wanted to be able to visualize our tests in one place without having to navigate through the code base.

This enabled us to visualize the following in our report group:

- Pass rate
- Average report duration
- Average number of test cases run
- Number of reports generated

CodeBuild reports allows you to drill deeper into each report generated by visualizing:

- Pass rate
- Report duration
- When the report was created
- Individual tests which are filterable by status

CodeBuild stores your test results for 30 days.

![CodeBuild report directory](/img/CodeBuild-Reports-Finder.png)

## Set up your infrastructure:

Firstly you will need to set up your infrastructure as code, in this scenario that happens to be using AWS CDK.

In your non prod and prod deployment stack add the following to your post build.
When you run Cypress in your local development you will see that is is waiting for a response from localhost to run the tests against. In the post build we can tell Cypress to go and run the integration tests on the specified url.

```ts
post_build: {
    commands: [
      "cd ../e2e && npm ci",
      "CYPRESS_BASE_URL=https://my-site-goes-here.com npm run report"
    ],
  }
```

In your non prod and prod deployment stack add the following to your reports section.
This adds the references to the files you want CodeBuild reports to generate. I included my unit tests and e2e tests.

Create an IAM policy which allows logging:

- logs:CreateLogStream
- logs:CreateLogGroup
- logs:PutLogEvents

Create an IAM policy which allows reporting:

- codebuild:CreateReportGroup
- codebuild:CreateReport
- codebuild:UpdateReport
- codebuild:BatchPutTestCases

```ts
reports: {
    CIReports: {
        files: ["frontend/junit.xml", "e2e/cypress/results/*.xml"],
        "discard-paths": "yes",
      },
    },

    new iam.PolicyStatement({
        actions: ["logs:CreateLogStream", "logs:CreateLogGroup", "logs:PutLogEvents"],
        effect: iam.Effect.ALLOW,
        resources: [
          `arn:aws:logs:${props.nonProdEnv.region}:${props.nonProdEnv.account}:log-group:/aws/codebuild/your-file-path-*`,
        ],
    }),

    new iam.PolicyStatement({
        actions: [
          "codebuild:CreateReportGroup",
          "codebuild:CreateReport",
          "codebuild:UpdateReport",
          "codebuild:BatchPutTestCases",
        ],
        effect: iam.Effect.ALLOW,
        resources: [
          `arn:aws:codebuild:${props.nonProdEnv.region}:${props.nonProdEnv.account}:report-group/your-file-path-*`,
        ],
    })
```

## Reporter config.json

In the reporter config specify what reporters you will be using in the reporter enabled property.
I used mocha junit reporter and specified where I want my files to be saved. This will need to be unique so I gave the file a unique hash value. This enabled me to merge the tests for the CodeBuild report.

**BEWARE: CodeBuild reports are very specific about what file formats are accepted**

For more information check out the documentation [here](https://docs.aws.amazon.com/codebuild/latest/userguide/test-reporting.html)

```json
{
  "reporterEnabled": "spec, mocha-junit-reporter",
  "mochaJunitReporterReporterOptions": {
    "mochaFile": "cypress/results/results-[hash].xml"
  }
}
```

## Cypress.json

In the Cypress json specify the reporter config we set up above.

```json
"reporter": "Cypress-multi-reporters",
 "reporterOptions": {
   "configFile": "reporter-config.json"
 }
```

## Package.json - in your Cypress directory

In the package.json in your Cypress directory set up the following script commands.
If the reports folder already exists then we want to remove everything in that folder before we run the e2e test.

```json
"scripts": {
    "test": "Cypress run",
    "cypress:open": "cypress open",
    "delete:reports": "rm cypress/results/* || true",
    "prereport": "npm run delete:reports",
    "report": "cypress run --reporter cypress-multi-reporters --reporter-options configFile=reporter-config.json"
}
```

## Wrapping up

We satisfied the project owners need to visualize test coverage in one place. Happy PO happy life.

If you have any questions, feel free to [contact-us](https://www.mechanicalrock.io/lets-get-started).

![Cypress CodeBuild report](/img/Cypress-CodeBuildReport.png)
